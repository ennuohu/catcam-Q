<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>国内极速版-霓虹手势</title>
    
    <!-- 1. 替换为国内 Eleme CDN 镜像 -->
    <script src="https://npm.elemecdn.com/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://npm.elemecdn.com/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://npm.elemecdn.com/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://npm.elemecdn.com/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body { margin: 0; background-color: #000; overflow: hidden; touch-action: none; font-family: sans-serif; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); z-index: 2; }
        .input_video { position: absolute; top: 10px; left: 10px; width: 80px; height: auto; z-index: 10; border: 1px solid #333; opacity: 0.5; transform: scaleX(-1); }
        #logs { position: absolute; bottom: 20px; width: 100%; text-align: center; color: #00ff00; font-size: 14px; text-shadow: 1px 1px 2px #000; z-index: 20; pointer-events: none;}
    </style>
</head>
<body>

    <video class="input_video" playsinline muted autoplay></video>
    <canvas class="output_canvas"></canvas>
    <div id="logs">正在通过国内节点加载模型...</div>

    <script type="module">
        const videoElement = document.getElementsByClassName('input_video')[0];
        const canvasElement = document.getElementsByClassName('output_canvas')[0];
        const ctx = canvasElement.getContext('2d');
        const logBox = document.getElementById('logs');

        function resize() {
            const dpr = window.devicePixelRatio || 1;
            canvasElement.width = window.innerWidth * dpr;
            canvasElement.height = window.innerHeight * dpr;
            ctx.scale(dpr, dpr);
        }
        window.addEventListener('resize', resize);
        resize();

        // --- 核心逻辑 ---
        function onResults(results) {
            ctx.clearRect(0, 0, canvasElement.width / (window.devicePixelRatio||1), canvasElement.height / (window.devicePixelRatio||1));
            
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                logBox.innerText = "系统正常运行中";
                for (const landmarks of results.multiHandLandmarks) {
                    drawNeonHand(ctx, landmarks);
                }
            } else {
                logBox.innerText = "未检测到手 (请在光线充足处测试)";
            }
        }

        // 简化的霓虹绘制函数
        function drawNeonHand(ctx, landmarks) {
            const w = canvasElement.width / (window.devicePixelRatio||1);
            const h = canvasElement.height / (window.devicePixelRatio||1);
            const pts = landmarks.map(l => ({x: l.x * w, y: l.y * h}));
            
            ctx.beginPath();
            const fingers = [[1,2,3,4], [5,6,7,8], [9,10,11,12], [13,14,15,16], [17,18,19,20]];
            
            // 简单连线逻辑，确保速度快
            fingers.forEach(idx => {
               ctx.moveTo(pts[idx[0]-1].x, pts[idx[0]-1].y); // 连到根部
               idx.forEach(i => ctx.lineTo(pts[i].x, pts[i].y));
            });
            // 手掌
            ctx.moveTo(pts[0].x, pts[0].y); ctx.lineTo(pts[5].x, pts[5].y);
            ctx.moveTo(pts[0].x, pts[0].y); ctx.lineTo(pts[17].x, pts[17].y);
            ctx.moveTo(pts[5].x, pts[5].y); ctx.lineTo(pts[9].x, pts[9].y);
            ctx.moveTo(pts[9].x, pts[9].y); ctx.lineTo(pts[13].x, pts[13].y);
            ctx.moveTo(pts[13].x, pts[13].y); ctx.lineTo(pts[17].x, pts[17].y);
            
            ctx.shadowColor = "#00FF00"; ctx.shadowBlur = 20;
            ctx.strokeStyle = "#00FF00"; ctx.lineWidth = 3; 
            ctx.lineJoin = "round"; ctx.lineCap = "round";
            ctx.stroke();
            ctx.shadowBlur = 0; ctx.strokeStyle = "#FFFFFF"; ctx.lineWidth = 1; ctx.stroke();
        }

        // 2. 关键修改：locateFile 指向国内镜像
        const hands = new Hands({locateFile: (file) => {
            // 强制从国内饿了么 CDN 下载模型文件 (.tflite, .wasm)
            return `https://npm.elemecdn.com/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 0, // 0=Lite(最快), 1=Full(普通)。手机建议0
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            facingMode: "user", width: 640, height: 480
        });

        camera.start().then(() => logBox.innerText = "摄像头已开启，正在下载模型...").catch(err => logBox.innerText = "错误: " + err);
    </script>
</body>
</html>
